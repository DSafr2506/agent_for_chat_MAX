## Personal Load Agent

Агент для анализа загруженности человека и качества рабочего дня. На вход принимает:

- **структурированный снапшот дня** (расписание, биометрия, опросы, задачи, коммуникации);
- **текстовое описание загруженности** (свободный текст);
- может работать через **CLI** или как **HTTP‑сервис**.

На выходе агент генерирует:

- **оценку риска выгорания** и факторы риска;
- **кривую энергии** по дню;
- **план микропауз и фокус‑блоков** с выгрузкой в формат ICS‑календаря;
- **гигиену встреч и советы по коммуникациям**;
- **коучинговое сообщение** от LLM;
- **рекомендации по эффективности**;
- **RAG‑советы**, как улучшить расписание и чем разнообразить день.

### Стек

- Python 3.10+
- Pydantic (модели данных)
- FastAPI (HTTP‑API)
- OpenRouter (LLM, по желанию через переменные окружения)

---

## Формат входных данных (Snapshot)

JSON‑объект `Snapshot` описывает один день пользователя:

- **user_id**: строка, идентификатор пользователя;
- **date**: ISO‑дата дня (`"2025-01-15"`);
- **tz**: часовой пояс (например, `"Europe/Moscow"`);
- **day**:
  - `work_start`: `"2025-01-15T09:00:00"`;
  - `work_end`: `"2025-01-15T18:00:00"`;
  - `lunch_start`, `lunch_end` (опционально);
  - `microbreak_minutes_every`: шаг между микропаузами в минутах;
  - `microbreak_len`: длительность микропауз;
  - `day_type`: `"workday" | "vacation" | "sick" | "weekend"`.
- **schedule**: список событий расписания (занятость):
  - `title`: название;
  - `start`, `end`: ISO‑время;
  - `type`: `"meeting" | "focus" | "break" | "personal" | "deadline" | "other"`;
  - `importance`: `"low" | "medium" | "high"` (опционально);
  - `source`: источник (опционально, например `"google_calendar"`).
- **biometrics** (опционально): шаги, сон, пульс, др.;
- **surveys** (опционально): точечные самоотчёты по шкале 1–10 (стресс, усталость и т.д.);
- **tasks** (опционально): блоки работы с переключениями и отвлечениями;
- **comms** (опционально): нагрузка по коммуникациям (чаты, почта, звонки);
- **rec_history**, **persona** (опционально): история работы с рекомендациями и предпочтения;
- **inbox_samples** (опционально): примеры писем/сообщений для анализа.

Минимальный пример:

```json
{
  "schema_version": "1.0",
  "user_id": "user-123",
  "date": "2025-01-15",
  "tz": "Europe/Moscow",
  "day": {
    "work_start": "2025-01-15T09:00:00",
    "work_end": "2025-01-15T18:00:00",
    "microbreak_minutes_every": 55,
    "microbreak_len": 5,
    "day_type": "workday"
  },
  "schedule": [],
  "biometrics": null,
  "surveys": [],
  "tasks": [],
  "comms": null,
  "rec_history": null,
  "persona": null,
  "inbox_samples": []
}
```

---

## Текстовый вход (анализ без структуры)

Если нет готового календаря и метрик, можно передать **свободный текст** с описанием загрузки:

- сколько встреч, созвонов, фокус‑задач;
- во сколько начинается и заканчивается день;
- как человек себя чувствует, что мешает.

Примеры текстов:

- `"Сегодня 6 встреч по часу, почти нет времени на фокус. Много чатов, к концу дня сильная усталость."`
- `"Рабочий день с 9 до 19, три крупных фокусных задачи, много контекст‑переключений и мелких задач."`

Для текста агент строит упрощённый снапшот и запускает тот же пайплайн анализа, включая RAG‑советы.

---

## Запуск через CLI

Основная CLI‑обёртка: `agent_pers.py`.

- **Анализ JSON‑файла со снапшотом:**

```bash
python agent_pers.py snapshot.json
```

- **Анализ массива снапшотов:**

```bash
python agent_pers.py snapshots_batch.json
```

где `snapshots_batch.json` содержит:

```json
[
  { "schema_version": "1.0", "user_id": "u1", "...": "..." },
  { "schema_version": "1.0", "user_id": "u2", "...": "..." }
]
```

- **Анализ снапшотов из `stdin`:**

```bash
cat snapshot.json | python agent_pers.py
```

Ответ печатается в `stdout` как JSON `Output`.

---

## HTTP‑модуль подключения

Файл `server.py` поднимает HTTP‑API на базе FastAPI.

### Установка зависимостей

Рекомендуется создать виртуальное окружение и установить зависимости:

```bash
pip install fastapi uvicorn pydantic httpx ics
```

При использовании LLM‑функций (коучинг, саммаризация, рекомендации по эффективности) нужно указать:

- `OPENROUTER_API_KEY` — ключ OpenRouter;
- по желанию `OPENROUTER_MODEL` (по умолчанию `google/gemma-2-27b-it`).

### Запуск сервера

Из корня проекта:

```bash
python server.py
```

По умолчанию сервер слушает `http://0.0.0.0:8000`.

### Эндпоинты

- **POST `/analyze`** — анализ структурированного `Snapshot`.

  - Вход: JSON `Snapshot` (см. схему выше).
  - Выход: JSON `Output`, содержащий:
    - `risk`, `energy_curve`, `plan`, `meeting_hygiene`,
      `comm_triage`, `wellbeing`, `efficiency_recommendations`,
      `ics_calendar`, `coach_message`, `rag_advice`.

  Пример:

  ```bash
  curl -X POST "http://localhost:8000/analyze" \
    -H "Content-Type: application/json" \
    -d @snapshot.json
  ```

- **POST `/analyze-text`** — анализ свободного текста.

  - Вход:

    ```json
    {
      "user_id": "user-123",
      "text": "Сегодня 6 встреч по часу, мало фокуса, сильная усталость",
      "tz": "Europe/Moscow"
    }
    ```

  - Выход: JSON `Output` с теми же полями, что и для `/analyze`.

  Пример:

  ```bash
  curl -X POST "http://localhost:8000/analyze-text" \
    -H "Content-Type: application/json" \
    -d '{
      "user_id": "user-123",
      "text": "Сегодня 6 встреч по часу, почти нет времени на фокус. К вечеру сильная усталость.",
      "tz": "Europe/Moscow"
    }'
  ```

---

## Как работает RAG‑поддержка

- В модуле `agents.rag` загружается небольшая база знаний:
  - из каталога `agents/knowledge` (`*.md` и `*.txt`, если есть);
  - либо встроенный текст с идеями, как разбавить день и сбалансировать нагрузку.
- Текст разбивается на блоки, для каждого блока строится простое представление по словам.
- На основе метрик дня (`Features`) и оценки риска (`RiskResult`) формируется краткий запрос:
  - много встреч, мало фокуса;
  - мало перерывов;
  - низкая активность;
  - повышенный риск выгорания и т.д.
- По этому запросу выбираются наиболее релевантные блоки из базы знаний.
- Эти блоки возвращаются как поле `rag_advice` в `Output`:
  - `suggestions`: список текстовых подсказок;
  - `sources`: имена файлов или `"builtin"`.

Таким образом, агент не только анализирует существующее расписание, но и подбирает готовые идеи, чем разнообразить день и как мягко скорректировать режим.

---

## Краткое резюме по использованию

- **Если есть календарь и данные**:
  - формируете JSON `Snapshot`;
  - вызываете либо `python agent_pers.py snapshot.json`,
    либо POST `/analyze` на HTTP‑сервер.

- **Если есть только текстовое описание дня**:
  - запускаете HTTP‑сервер `python server.py`;
  - отправляете запрос на `/analyze-text` с полями `user_id`, `text`, `tz`.

В обоих случаях на выходе получаете структурированный набор рекомендаций по расписанию, качеству дня и идеям для его разнообразия.


